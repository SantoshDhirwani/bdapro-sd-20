import time
from core.services.coreservices import CoreService, ServiceMode
import os


class FlinkJobService(CoreService):
    name = "FlinkJobService"
    group = "BDAPRO"
    executables = ()
    dependencies = ()
    dirs = ()
    configs = ("flink_job.sh",)
    startup =  ("sh flink_job.sh",)
    validate = ()
    validation_mode = ServiceMode.NON_BLOCKING
    validation_timer = 5
    validation_period = 0.5
    shutdown = ()

    @classmethod
    def generate_config(cls, node, filename):
        """
        Returns a string representation for a file, given the node the service is starting on the config filename
        that this information will be used for. This must be defined, if "configs" are defined.

        :param node: core node that the service is being ran on
        :param str filename: configuration file to generate
        :return: configuration file content
        :rtype: str
        """

        timestamp = time.strftime('%H:%M:%S')
        FLINK_PATH = os.path.join(os.path.expanduser('~'),'Downloads', 'BDAPRO', 'flink-1.10.1','bin','flink')
        FLINK_JOB_PATH = os.path.join(os.path.expanduser('~'),'Downloads', 'BDAPRO', 'FlinkJobsMisc','target','masterthesis-jobs-1.0-SNAPSHOT.jar')

        cfg = "#!/bin/sh\n"
        cfg += "#auto-generated by FlinkJobService (flink_job.py)\n"
        cfg += "export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64\n"
        cfg += f"echo '{timestamp} - Started running Flink Job on Node: {node.name}' >> /home/kevingu/Desktop/service_logs/job_log\n"
        # cfg += "sudo {flink} run -c de.adrianbartnik.benchmarks.yahoo.YahooBenchmark {job} -hostnames localhost -ports 0".format(flink = os.path.join(FLINK_PATH,'bin'),job = FLINK_JOB_PATH)
        cfg += f"#runuser -l kevingu -c '{FLINK_PATH} run -m 10.20.0.1:6123 -c de.adrianbartnik.benchmarks.yahoo.YahooBenchmark {FLINK_JOB_PATH} -hostnames 10.20.0.2 -ports 0 -path /home/kevingu/Downloads/BDAPRO/Outputs/'\n"
        cfg += f"echo '{timestamp} - Finished running Flink Job on Node: {node.name}' >> /home/kevingu/Desktop/service_logs/job_log"

# /home/kevingu/Downloads/BDAPRO/flink-1.10.1/bin/flink run -m 10.20.0.1:6123 -c de.adrianbartnik.benchmarks.yahoo.YahooBenchmark /home/kevingu/Downloads/BDAPRO/FlinkJobsMisc/target/masterthesis-jobs-1.0-SNAPSHOT.jar -hostnames 10.20.0.2 -ports 0 -path /home/kevingu/Downloads/BDAPRO/Outputs/


        # subprocess.run(['sudo', os.path.join(FLINK_PATH,'bin'), 'run', '-c','de.adrianbartnik.benchmarks.yahoo.YahooBenchmark',FLINK_JOB_PATH,'-hostnames', 'localhost','-ports','0'])
        return cfg

